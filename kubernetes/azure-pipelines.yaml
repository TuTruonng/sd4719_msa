trigger:
  branches:
    include:
      - main

pool:
  name: 'Default'

variables:
  dockerRegistryServiceConnection: 'ACR-ServiceConnection'
  kubernetesServiceConnection: 'AKS-ServiceConnection'
  containerRegistry: 'mydemoacrregistry'
  azureServiceConnection: 'AzureRM-Connection'
  acrServiceConnection: 'ACR-ServiceConnection'
  aksResourceGroup: 'demo-rg'
  aksClusterName: 'demo-aks-cluster'
  frontendImageName: 'frontend'
  backendImageName: 'backend'
  imageTag: '$(Build.BuildId)'
  namespace: 'default'

  backendImageUri: '$(containerRegistry)/$(backendImageName):$(imageTag)'
  frontendImageUri: '$(containerRegistry)/$(frontendImageName):$(imageTag)'

stages:
- stage: BuildAndPush
  displayName: Build and Push Docker Images
  jobs:
  - job: BuildPushJob
    displayName: Build and Push Frontend and Backend
    steps:

    # Build and Push Frontend Docker Image
    - task: Docker@2
      displayName: Build and Push frontend Docker image
      inputs:
        containerRegistry: $(dockerRegistryServiceConnection)
        repository: $(frontendImageName)
        command: buildAndPush
        Dockerfile: $(Build.SourcesDirectory)/kubernetes/src/frontend/Dockerfile
        tags: |
          $(imageTag)
        buildContext: $(Build.SourcesDirectory)/kubernetes/src/frontend

    # Build and Push Backend Docker Image
    - task: Docker@2
      displayName: Build and Push backend Docker image
      inputs:
        containerRegistry: $(dockerRegistryServiceConnection)
        repository: $(backendImageName)
        command: buildAndPush
        Dockerfile: $(Build.SourcesDirectory)/kubernetes/src/backend/Dockerfile
        tags: |
          $(imageTag)
        buildContext: $(Build.SourcesDirectory)/kubernetes/src/backend

    # Update manifest files with new image tags
    - task: Bash@3
      displayName: Update Kubernetes manifests with new image tags
      inputs:
        targetType: 'inline'
        script: |
          echo "Updating image tags in Kubernetes manifests..."
          sed -i "s|image:.*backend.*|image: $(backendImageUri)|g" Manifest-Azure/backend.yaml
          sed -i "s|image:.*frontend.*|image: $(frontendImageUri)|g" Manifest-Azure/frontend.yaml
          echo "Updated manifests successfully."

- stage: Deploy
  displayName: Deploy to AKS
  dependsOn: BuildAndPush
  jobs:
  - job: DeployToAKS
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      inputs:
        azureSubscription: '$(azureServiceConnection)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az aks get-credentials --resource-group $(aksResourceGroup) --name $(aksClusterName)
          kubectl apply -f kubernetes/

# - stage: Deploy
#   displayName: Deploy to AKS
#   dependsOn: BuildAndPush
#   jobs:
#   - deployment: DeployToAKS
#     displayName: Deploy Kubernetes Manifests to AKS
#     environment: 'production'
#     strategy:
#       runOnce:
#         deploy:
#           steps:
#           - download: current
#             artifact: manifests

#           - task: Kubernetes@1
#             displayName: Deploy MongoDB
#             inputs:
#               connectionType: 'Kubernetes Service Connection'
#               kubernetesServiceEndpoint: $(kubernetesServiceConnection)
#               namespace: $(namespace)
#               command: apply
#               useConfigurationFile: true
#               configuration: '$(Pipeline.Workspace)/manifests/mongodb.yaml'

#           - task: Kubernetes@1
#             displayName: Deploy Backend
#             inputs:
#               connectionType: 'Kubernetes Service Connection'
#               kubernetesServiceEndpoint: $(kubernetesServiceConnection)
#               namespace: $(namespace)
#               command: apply
#               useConfigurationFile: true
#               configuration: '$(Pipeline.Workspace)/manifests/backend.yaml'

#           - task: Kubernetes@1
#             displayName: Deploy Frontend
#             inputs:
#               connectionType: 'Kubernetes Service Connection'
#               kubernetesServiceEndpoint: $(kubernetesServiceConnection)
#               namespace: $(namespace)
#               command: apply
#               useConfigurationFile: true
#               configuration: '$(Pipeline.Workspace)/manifests/frontend.yaml'